name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  # Keep these in one place so we can bump the supported macOS baseline easily.
  TARGET_MACOS_VERSION: "15.5"
  # Keep this conservative; raise over time as tests improve.
  MIN_UNIT_TEST_COVERAGE_PERCENT: "48"

jobs:
  build-and-test:
    strategy:
      matrix:
        runner: [macos-15]
    # Pin runner to keep Homebrew dylib compatibility stable for distribution.
    # We target macOS >= TARGET_MACOS_VERSION, so ensure Homebrew bottles are built with minos <= that.
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Runner info
        run: |
          set -euo pipefail
          sw_vers
          uname -a
          uname -m

      - name: Assert Apple silicon runner
        run: |
          set -euo pipefail
          test "$(uname -m)" = "arm64"

      - name: Xcode version
        run: xcodebuild -version

      - name: Install LibRaw (Homebrew)
        run: |
          set -euo pipefail
          brew install libraw
          LIBRAW_PREFIX="$(brew --prefix libraw)"
          echo "LIBRAW_PREFIX=$LIBRAW_PREFIX" >> "$GITHUB_ENV"

      - name: Verify LibRaw min macOS (<= 15.5)
        run: |
          set -euo pipefail
          test -n "${LIBRAW_PREFIX:-}"

          ls -1 "${LIBRAW_PREFIX}/lib"/libraw*.dylib >/dev/null
          bash bin/check-dylib-minos.sh "${TARGET_MACOS_VERSION}" "${LIBRAW_PREFIX}/lib"/libraw*.dylib

      - name: Enable LibRaw in build (xcconfig)
        run: |
          set -euo pipefail
          test -n "${LIBRAW_PREFIX:-}"
          cat > LibRaw.xcconfig <<EOF
          // Auto-generated in CI (gitignored) to enable RAW decoding via LibRaw.
          LIBRAW_PREFIX = ${LIBRAW_PREFIX}
          GCC_PREPROCESSOR_DEFINITIONS = \$(inherited) LIBRAW_ENABLED=1
          HEADER_SEARCH_PATHS = \$(inherited) \$(LIBRAW_PREFIX)/include
          LIBRARY_SEARCH_PATHS = \$(inherited) \$(LIBRAW_PREFIX)/lib
          OTHER_LDFLAGS = \$(inherited) -lraw
          EOF

      - name: Build Release app (arm64, no signing)
        run: |
          set -euo pipefail
          xcodebuild \
            -scheme Muraloom \
            -destination 'platform=macOS' \
            -configuration Release \
            -derivedDataPath /tmp/muraloom_deriveddata_release \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            build

          mkdir -p build/ci
          rm -rf build/ci/Muraloom.app
          ditto /tmp/muraloom_deriveddata_release/Build/Products/Release/Muraloom.app build/ci/Muraloom.app

      - name: Bundle Homebrew dylibs into app
        run: |
          set -euo pipefail
          bash bin/bundle-homebrew-dylibs.sh build/ci/Muraloom.app Muraloom Muraloom/Muraloom.entitlements /opt/homebrew

      - name: Verify no /opt/homebrew links remain
        run: |
          set -euo pipefail
          if otool -L build/ci/Muraloom.app/Contents/MacOS/Muraloom | grep "/opt/homebrew"; then
            echo "ERROR: App still links against /opt/homebrew paths" >&2
            exit 1
          fi
          if find build/ci/Muraloom.app/Contents/Frameworks -maxdepth 1 -type f -name "*.dylib" -print0 | xargs -0 -n 1 otool -L | grep "/opt/homebrew"; then
            echo "ERROR: Bundled dylib(s) still link against /opt/homebrew paths" >&2
            exit 1
          fi

      - name: Verify bundled dylibs min macOS (<= 15.5)
        run: |
          set -euo pipefail
          # It's OK if there are no dylibs (LibRaw optional), but if present they must be <= 15.5.
          if ls -1 build/ci/Muraloom.app/Contents/Frameworks/*.dylib >/dev/null 2>&1; then
            bash bin/check-dylib-minos.sh "${TARGET_MACOS_VERSION}" build/ci/Muraloom.app/Contents/Frameworks/*.dylib
          else
            echo "No bundled dylibs found; skipping minos check"
          fi

      - name: Unit tests + coverage (no UI tests, no signing)
        run: |
          set -euo pipefail
          xcodebuild \
            -scheme Muraloom \
            -destination 'platform=macOS' \
            -derivedDataPath /tmp/muraloom_deriveddata_test \
            -resultBundlePath /tmp/muraloom_tests.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            test \
            -only-testing:MuraloomTests

      - name: Coverage gate
        run: |
          set -euo pipefail
          # Gate is unit-test-only; UI tests run separately and do not affect /tmp/muraloom_tests.xcresult.
          bash bin/coverage-gate.sh /tmp/muraloom_tests.xcresult "${MIN_UNIT_TEST_COVERAGE_PERCENT}" Muraloom

      - name: UI tests (hermetic, ad-hoc signed)
        run: |
          set -euo pipefail
          # UI tests require a runnable test runner app. Ad-hoc sign it, but strip entitlements so this works without a dev cert.
          xcodebuild \
            -scheme Muraloom \
            -destination 'platform=macOS' \
            -derivedDataPath /tmp/muraloom_deriveddata_ui_test \
            -resultBundlePath /tmp/muraloom_ui_tests.xcresult \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGN_ENTITLEMENTS="" \
            test \
            -only-testing:MuraloomUITests

      - name: Upload xcresult bundles (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcresults
          path: |
            /tmp/muraloom_tests.xcresult
            /tmp/muraloom_ui_tests.xcresult

      - name: Create distributable zip (for artifacts)
        run: |
          set -euo pipefail
          mkdir -p build/artifacts
          rm -f build/artifacts/Muraloom-Release-arm64.zip
          ditto -c -k --sequesterRsrc --keepParent build/ci/Muraloom.app build/artifacts/Muraloom-Release-arm64.zip

      - name: Upload Release app artifact
        uses: actions/upload-artifact@v4
        with:
          name: Muraloom-Release-arm64
          path: build/artifacts/Muraloom-Release-arm64.zip
